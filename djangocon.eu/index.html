<!doctype html>
<html lang="en" xmlns="http://www.w3.org/1999/html"
      xmlns="http://www.w3.org/1999/html">
	
	<head>
		<meta charset="utf-8">
		
		<title>Djangocon EU 2012: Continuous Introspection</title>

		<meta name="description" content="Djangocon EU 2012: Healthy WebApps Through Continuous Introspection.">
		<meta name="author" content="Erik van Zijst">

		<meta name="apple-mobile-web-app-capable" content="yes" />
		<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
		
		<link href='http://fonts.googleapis.com/css?family=Lato:400,700,400italic,700italic' rel='stylesheet' type='text/css'>
		
		<link rel="stylesheet" href="css/reset.css">
		<link rel="stylesheet" href="css/main.css">
		<link rel="stylesheet" href="css/print.css" type="text/css" media="print">

		<link rel="stylesheet" href="lib/zenburn.css">
	</head>
	
	<body>
		
		<div id="reveal">

			<!-- Used to fade in a background when a specific slide state is reached -->
			<div class="state-background"></div>
			
			<!-- Any section element inside of this container is displayed as a slide -->
			<div class="slides">

        <section>
          <h2>Continuous Introspection</h2>
          (finding the slow bits)
          <div id="erik-van-zijst">
            <p>Erik van Zijst</p>
            <p><a href="https://twitter.com/erikvanzijst">@erikvanzijst</a></p>
            <p><a href="https://bitbucket.org/evzijst">bitbucket.org/evzijst</a></p>
          </div>
          <script>
            // Delicously hacky. Look away.
            if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
              document.write('<p style="color:rgba(0,0,0,0.3);text-shadow:none">(Tap to navigate)</p>');
            }
          </script>
				</section>


          <!--
          Introduction: name and Bitbucket
          Bitbucket is popular and grows quickly
          hardware needs to scale, add servers constantly
          drives interest in performance tuning (show load graph?)

          -->

        <section>
          <!--
          Discovered conq in top (top 4 procs, 100% cpu, 300MB RAM)
          conq is ssh login shell, spawns children (git, hg)
          must not use cpu
          discovered: conq is python, imports django, uses orm
          rewrite with plain sql, 60% load reduction across all frontends and
            much faster ssh response times
          show load graph

          -->
          <h2>Wasted Cycles on Bitbucket</h2>
          <img src="conq.png">
          <ul class="fragment">
            <li><em>60%</em> load decrease on all web servers!</li>
            <li>Much faster response times</li>
          </ul>
          <img class="fragment" src="load.png">
        </section>

          <!--
          Not all hotspots are bad; it's the ones doing redundant work
          mpeg encoder will always have a hotspot in DCT transforms
          in webapps, anything that adds to render time is bad

          -->

        <section>
          <!--
          In reality, many sources of slowness lurk in web apps:
          - evil regexps
          - exponential complexity algorithms
          - slow SQL query
          - lock contention
          -- threads
          -- table/row locks on slow transactions
          -- file locks (bb repos)
          - excessive disk IO (DAG traversals)
          - excessive network IO (chatty NFS, too granular memcached keys)

          Slowness often context-dependent (won't see it on a dev instance), so
          the talk focuses on tools that can be used on production.

          -->
          <h2>Slowness in Web Apps</h2>
          <ul>
            <li class="fragment">
              <p>slow SQL queries (or too many!)</p>
            </li>
            <li class="fragment">
              <p>algorithms with exponential complexity</p>
            </li>
            <li class="fragment">
              <p>lock contention:</p>
              <ul>
                <li>between threads</li>
                <li>database table/row locks</li>
                <li>file locks (git/hg)</li>
              </ul>
            </li>
            <li class="fragment">
              <p>excessive IO (disk/network)</p>
            </li>
            <li class="fragment">
              <p>evil regexps: <code style="margin-left:16px;color:#cc9393">r'^(a+)+$'</code></p>
            </li>
          </ul>
          <p>&nbsp;</p>
          <p class="fragment">(<em>Slowness is often context-dependent</em>)</p>
        </section>

        <section>
          <!--
          When pages are slow:
          Consequences of slow pages:
          - 503s: worker pools full
          - 500s: if webserver SIGKILLs (plus stale state: lock files, txs)

          -->
          <h2>Consequences</h2>
          <p>&nbsp;</p>
          <ul>
            <li><b>503</b> &mdash; worker pools full</li>
            <li><b>500</b> &mdash; if requests time out (Gunicorn SIGKILL)</li>
          </ul>
          <p>&nbsp;</p>
          <p>
            The latter is best avoided as it destroys forensic evidence and
            leaves stale state (e.g. lock files)
          </p>
        </section>

          <!--
          Normal way to find slowness is profiling, but:
          expensive, impossible in production
          dev envs usually lack data-set, clustering and concurrency

          -->

        <section>
          <section>
            <!--
            Django-Geordi
            replay prod request with profiling
            produces pdf call graph
            runs outside the worker pool without timeouts (celery)

            Can do staging request live?

            -->
            <h2>Meet django-geordi</h2>

            <img id="geordi" src="geordilaforge.jpg" />
            <ul>
              <li>
                <p>add "<code>?__geordi__</code>" to any URL<p>
              </li>
              <li>
                <p>replay prod request with profiling</p>
              </li>
              <li>
                <p>produces pdf call graph</p>
              </li>
              <li>
                <p>runs outside the worker pool without timeouts (celeryd)</p>
              </li>
            </ul>
          </section>

          <section>
            <p><img src="geordi1.png"/></p>
          </section>
        </section>

        <section>

          <section>
            <!--
            Dogslow
            automatic emails on slow requests
            non-invasive, no performance penalty, safe on prod

            Slow pages still get killed, but now we know about it
            Used by Instagram

            -->
            <h2>Dogslow</h2>
            <ul>
              <li>
                <p>Django middleware</p>
              </li>
              <li>
                <p>emails tracebacks of slow requests</p>
              </li>
              <li>
                <p>no performance penalty, safe on prod</p>
              </li>
            </ul>
            <p>&nbsp;</p>
          </section>

          <section>
            <p>Email from Dogslow catching a slow hg blame page:</p>
            <p>&nbsp;</p>
            <pre><code>
            Subject: Slow Request Watchdog: GET /annotate/521ae2309f0b/adblocklist.txt
            From: notifications-noreply@atlassian.com
            To: bitbucket-errors@atlassian.com
            Date: Tue, 22 May 2012 21:14:30 -0000


            GET /annotate/521ae2309f0b/adblocklist.txt
            Thread ID:  140143111386880
            Process ID: 19530
            Started:    22-05-2012 21:14:05 UTC

              File "bitbucket/apps/repo2/views.py", line 792, in annotate
                blame = file_.blame()
              File "site-packages/orochi/base.py", line 1208, in wrapper
                return func(self, *args, **kwargs)
              File "site-packages/orochi/hg.py", line 606, in blame
                self._fctx.annotate(linenumber=False)]
              File "site-packages/mercurial/context.py", line 509, in annotate
                curr = decorate(f.data(), f)
              File "site-packages/mercurial/context.py", line 360, in data
                return self._filelog.read(self._filenode)
              File "site-packages/mercurial/filelog.py", line 40, in read
                return t
              File "site-packages/mercurial/revlog.py", line 904, in revision
                text = self._checkhash(text, node, rev)
              File "site-packages/mercurial/revlog.py", line 911, in _checkhash
                if node != hash(text, p1, p2):
              File "site-packages/mercurial/revlog.py", line 75, in hash
                s.update(text)
            </code></pre>

          </section>
        </section>

        <section>
          <section>
            <!--
            Interruptingcow
            Send non-lethal exception to process before webserver SIGKILL:
            - prevent empty response (500 with crucial backtrace instead)
            - ensure proper resource closing (explicit db rollback, release lock files)
            - avoid worker process restart
            - uses UNIX signals, interrupts regardless of GIL

            -->
            <h2>Interruptingcow</h2>
            <ul>
              <li>
                <p>raises a <code>RuntimeError</code> in the worker</p>
              </li>
              <li>
                <p>fail in a controlled manner</p>
              </li>
              <li>
                <p>ensure proper cleanup (db, lock files)</p>
              </li>
              <li>
                <p>uses UNIX signals (SIGALRM, GIL-proof)</p>
              </li>
            </ul>
          </section>

          <section>
            <!--
            Timebox operations with Interruptingcow
            no more regexp of death
            code sample
            Used by BB to linkify?

            -->
            <h2>Timebox expensive operations</h2>
            <pre><code>
              from interruptingcow import timeout

              try:
                  with timeout(20.0, RuntimeError):
                      while True:
                          # expensive loop
                          pass
              except RuntimeError:
                  print 'Interrupted'
            </code></pre>
            <!-- useful for:
              - linkification
              - code highlighting
            -->

          </section>

          <section>
            <h2>Nested timeouts</h2>
            <pre><code>
              from interruptingcow import timeout

              class Outer(RuntimeError):
                  pass

              class Inner(RuntimeError):
                  pass

              try:
                  with timeout(20.0, Outer):
                      try:
                          with timeout(1.0, Inner):
                              # some expensive operation
                              try_the_expensive_thing()
                      except Inner:
                          do_the_cheap_thing_instead()

              except Outer:
                  print 'Program as a whole failed to return in 20 secs'
            </code></pre>
          </section>
        </section>

        <section>
          <!--
          Summary

          - Geordi
          -- Profile production
          - Dogslow
          -- tracebacks of slow requests
          - Interruptingcow
          -- timebox expensive code and fail gracefully
          -->
          <h2>Summary</h2>
          <ul id="summary">
            <li>
              <p><b>Geordi</b> &mdash; profile production environments</p>
              <p><a href="https://bitbucket.org/brodie/geordi">bitbucket.org/brodie/geordi</a></p>
            </li>
            <li>
              <p><b>Dogslow</b> &mdash; tracebacks of slow requests <small><em>used by Instagram :)</em></small></p>
              <p><a href="https://bitbucket.org/evzijst/dogslow">bitbucket.org/evzijst/dogslow</a></p>
            </li>
            <li>
              <p><b>Interruptingcow</b> &mdash; prevent slowness and fail gracefully</p>
              <p><a href="https://bitbucket.org/evzijst/interruptingcow">bitbucket.org/evzijst/interruptingcow</a></p>
            </li>
          </ul>
        </section>
			</div>

			<!-- The navigational controls UI -->
			<aside class="controls">
				<a class="left" href="#">&#x25C4;</a>
				<a class="right" href="#">&#x25BA;</a>
				<a class="up" href="#">&#x25B2;</a>
				<a class="down" href="#">&#x25BC;</a>
			</aside>

			<!-- Displays presentation progress, max value changes via JS to reflect # of slides -->
			<div class="progress"><span></span></div>
			
		</div>
		
		<script src="js/reveal.js"></script>

		<!-- Optional libraries for code syntax highlighting and classList support in IE9 -->
		<script src="lib/highlight.js"></script>
		<script src="lib/classList.js"></script>
		
		<script>
			// Parse the query string into a key/value object
			var query = {};
			location.search.replace( /[A-Z0-9]+?=(\w*)/gi, function(a) {
				query[ a.split( '=' ).shift() ] = a.split( '=' ).pop();
			} );

			Reveal.initialize({
				// Display controls in the bottom right corner
				controls: true,

				// Display a presentation progress bar
				progress: true,

				// If true; each slide will be pushed to the browser history
				history: true,

				// Loops the presentation, defaults to false
				loop: false,

				// Flags if mouse wheel navigation should be enabled
				mouseWheel: true,

				// Apply a 3D roll to links on hover
				rollingLinks: false,

				// UI style
				theme: query.theme || 'default', // default/neon

				// Transition style
				transition: query.transition || 'default' // default/cube/page/concave/linear(2d)
			});

			hljs.initHighlightingOnLoad();
		</script>


	</body>
</html>
